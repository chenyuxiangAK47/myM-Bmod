# 出身系统实现分析

## 一、快速开始按钮状态

### 当前状态
- ❌ **主菜单按钮未实现**：当前编译的是简化版本（`WelcomeMessageSimple.cs`），不包含 Harmony 补丁
- ✅ **自动给金币已实现**：每次新游戏自动获得 100,000 金币
- ⚠️ **完整版本需要**：编译 `MyMod.csproj`（需要 .NET SDK 或修改为传统格式）

### 实现主菜单按钮需要
1. 编译完整版本（包含 `QuickStartPatches.cs`）
2. 或安装 .NET SDK 后编译 `MyMod.csproj`

---

## 二、出身系统可行性分析

### ✅ **可以做，但实现成本较高**

---

## 三、技术可行性

### 1. 预设出身（Preset Origin）
**可行性：⭐⭐⭐⭐（高）**

#### 实现方式
- **XML 配置**：使用 `spclans.xml` 和 `spkingdoms.xml` 定义初始状态
- **C# 逻辑**：在 `OnCampaignStart` 或 `OnNewGameCreated` 中应用初始状态
- **Harmony 补丁**：修改角色创建流程，添加预设出身选择

#### 需要实现的内容
1. **初始外交关系**
   - 使用 `ChangeRelationAction` 设置与各派系的关系
   - 使用 `DeclareWarAction` 设置敌对状态

2. **初始兵力**
   - 使用 `PartyTemplate` 创建初始部队
   - 或直接添加单位到玩家队伍

3. **初始财富**
   - 使用 `GiveGoldAction` 设置初始金币
   - 设置初始物品

4. **家族等级和成员**
   - 修改 `Clan` 的 `Tier` 属性
   - 创建初始家族成员（NPC）

5. **世界标签**
   - 设置 `IsOutlaw`、`IsBandit` 等标志
   - 使用 `CampaignCheats` 或自定义逻辑

#### 实现难度：**中等**
- 大部分功能可以通过现有 API 实现
- 需要熟悉 Bannerlord 的 Campaign 系统
- 需要处理各种边界情况

---

### 2. 非预设出身（Non-Preset Origin）
**可行性：⭐⭐⭐⭐⭐（非常高）**

#### 实现方式
- **XML 表驱动**：定义社会出身、技能来源、当前状态的选项
- **C# 组合逻辑**：根据三步选择组合生成最终状态
- **Harmony 补丁**：修改角色创建 UI，添加三步选择界面

#### 需要实现的内容
1. **社会出身（Step 1）**
   - 初始财富范围
   - 初始装备池
   - 属性倾向

2. **技能来源（Step 2）**
   - 熟练度分配
   - 初始武器类型
   - 技能点分配

3. **当前状态（Step 3）**
   - 初始队伍成员
   - 初始资金
   - 初始状态（受伤、疲惫等）

#### 实现难度：**低到中等**
- 主要是数值组合，不需要复杂逻辑
- UI 修改可能需要 Harmony 补丁
- 或者可以复用现有的角色创建流程

---

## 四、实现成本评估

### 预设出身
- **开发时间**：2-3 周（10 个预设模板）
- **技术难度**：中等
- **主要工作**：
  - 设计每个预设的初始状态
  - 编写 C# 逻辑应用状态
  - 测试各种边界情况
  - UI 修改（添加预设选择）

### 非预设出身
- **开发时间**：1-2 周
- **技术难度**：低到中等
- **主要工作**：
  - 设计选项清单
  - 编写组合逻辑
  - UI 修改（三步选择）
  - 平衡数值

### 总计
- **完整实现**：3-5 周
- **MVP 版本**（只有非预设）：1-2 周

---

## 五、技术实现方案

### 方案 1：纯 XML + C#（推荐）
- 使用 XML 定义出身选项和初始状态
- 使用 C# 在 `OnNewGameCreated` 中应用
- **优点**：简单、易维护
- **缺点**：UI 修改需要 Harmony

### 方案 2：Harmony 补丁 + XML
- 使用 Harmony 修改角色创建流程
- 添加新的选择界面
- **优点**：完全自定义
- **缺点**：复杂度高，需要深入理解 Bannerlord 内部结构

### 方案 3：混合方案（推荐）
- 非预设出身：使用现有角色创建流程，只修改数值
- 预设出身：添加新的选择界面（Harmony 或 UIExtenderEx）
- **优点**：平衡了复杂度和功能
- **缺点**：需要两套实现

---

## 六、关键 API 和类

### 需要使用的 Bannerlord API
1. **角色创建**
   - `CharacterCreationState`
   - `CharacterCreationContent`
   - `CharacterCreationStage`

2. **初始状态**
   - `Campaign.Current` - 当前战役
   - `Hero.MainHero` - 玩家角色
   - `Clan.PlayerClan` - 玩家家族
   - `MobileParty.MainParty` - 玩家队伍

3. **外交关系**
   - `ChangeRelationAction`
   - `DeclareWarAction`
   - `MakePeaceAction`

4. **队伍和单位**
   - `PartyTemplate`
   - `AddHeroToParty`
   - `AddTroopToParty`

5. **财富和物品**
   - `GiveGoldAction`
   - `GiveItemAction`

---

## 七、实现建议

### 阶段 1：MVP（最小可行产品）
1. **只实现非预设出身**
   - 使用现有角色创建流程
   - 在 `OnNewGameCreated` 中根据选择应用状态
   - 不修改 UI，只修改数值

2. **实现 1-2 个预设出身作为示例**
   - 验证技术可行性
   - 测试初始状态应用逻辑

### 阶段 2：完整实现
1. **实现所有预设出身**
2. **添加 UI 选择界面**
3. **实现非预设 → 预设的转化机制**

---

## 八、潜在问题和解决方案

### 问题 1：角色创建流程复杂
- **解决方案**：使用 Harmony 补丁拦截关键方法，或使用 UIExtenderEx 扩展 UI

### 问题 2：初始状态可能冲突
- **解决方案**：仔细设计状态应用顺序，使用标志位避免重复应用

### 问题 3：与其他模组兼容性
- **解决方案**：使用 Harmony 的优先级机制，确保补丁顺序正确

---

## 九、结论

### ✅ **可以做**
- 技术可行性高
- 大部分功能可以通过现有 API 实现
- 需要一定的开发时间

### 📊 **实现成本**
- **MVP 版本**：1-2 周
- **完整版本**：3-5 周
- **技术难度**：中等

### 🎯 **推荐实现顺序**
1. 先实现非预设出身（简单、验证可行性）
2. 再实现预设出身（复杂、需要更多测试）
3. 最后添加 UI 和转化机制

---

## 十、下一步

如果你决定实现，我可以：
1. 创建出身系统的 XML 配置文件结构
2. 编写 C# 代码实现初始状态应用逻辑
3. 设计 UI 修改方案（如果需要）
4. 实现第一个预设出身作为示例
